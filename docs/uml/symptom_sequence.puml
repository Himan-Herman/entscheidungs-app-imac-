@startuml symptom_sequence
autonumber
skinparam participantStyle rectangle

actor User
participant "React-Frontend\n(SymptomView)" as FE
participant "Backend\n(/api/symptom)" as BE
participant "KIClient\n(openaiClient)" as KIC
participant "OpenAI\nThreads API" as OA

title Symptom-Chat mit eigener symptomThreadId

== Erstes Symptom (Thread anlegen) ==

User -> FE : Symptom eingeben(\"Kopfschmerzen\")
FE -> FE : getOrCreateSymptomThreadId()

alt symptomThreadId existiert NICHT
  FE -> BE : POST /api/symptom\n{text, threadId: null}
  BE -> KIC : createThread()
  KIC -> OA : POST /threads
  OA --> KIC : threadId
  KIC --> BE : threadId
  BE --> FE : { replyText: \"Thread erstellt\", threadId }
  note right of FE
    Frontend speichert symptomThreadId
    z.B. im State oder LocalStorage.
  end note
else symptomThreadId existiert bereits
  FE -> BE : POST /api/symptom\n{text, threadId}
end

== Nachricht an KI schicken ==

BE -> KIC : sendMessage(threadId, text)
KIC -> OA : POST /threads/{threadId}/messages
OA --> KIC : 202 Accepted

BE -> KIC : getResponse(threadId)
KIC -> OA : POST /threads/{threadId}/runs
OA --> KIC : Antwort\n(Rückfrage oder Empfehlung)
KIC --> BE : assistantMessage
BE --> FE : { replyText, threadId }

FE --> User : Antwort im Chat anzeigen

== Folgefragen (gleicher Thread) ==

User -> FE : Rückfrage beantworten
FE -> BE : POST /api/symptom\n{text, threadId}
BE -> KIC : sendMessage(threadId, text)
... (gleiche Schritte wie oben) ...

note over BE, KIC
  Alle Nachrichten dieses Bereichs
  verwenden symptomThreadId.
  Body Map und Bildanalyse
  haben ihre jeweils eigenen
  threadIds (getrennte Kontexte).
end note

@enduml
